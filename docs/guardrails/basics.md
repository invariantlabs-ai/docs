---
title: Agents and Traces
description: Learn about Guardrails' primitives to model agent behavior.
icon: bootstrap/box
---

# Agents and Traces
<div class="subtitle">Learn about Guardrails primitives to model agent behavior for guardrailing.</div>

Invariant uses a simple yet powerful event-based trace model of agentic interactions, derived from the [OpenAI chat data structure](https://platform.openai.com/docs/api-reference/chat/create).

To use [Guardrails](./index.md) and [Explorer](../explorer/index.md), your agentic interactions must be represented as a sequence of `Event` objects, as described below. If you are already using [Gateway](../gateway/index.md), all your LLM and MCP interactions __will be automatically transformed into this format__.

<div class="format-explainer">
    <div class="graph">
        <b>Execution Graph</b>
        <div class="node user-message highlight active" data-highlight-id="user-message" style="margin-top: 0pt;">
            <span class="off">User Message</span>
            <br/><span class="on"><code>(msg: Message)<br/>msg.role == "user"</code></span>
        </div>
        <div class="edge" style="height: 15pt;"></div>
        <div class="node assistant-message" data-highlight-id="assistant-message">
            <span class="off">Assistant Message</span>
            <br/><span class="on"><code>(msg: Message)<br/>msg.role == "assistant"</code></span>
            <div class="node tool-call" data-highlight-id="tool-call">
                <span class="off">Tool Call</span>
                <br/><span class="on"><code>(call: ToolCall)</code></span>
            </div>
        </div>
        <div class="edge" style="height: 140pt;"></div>
        <div class="node tool-output" data-highlight-id="tool-output">
            <span class="off">Tool Output</span>
            <br/><span class="on"><code>(output: ToolOutput)</code></span>
        </div>
    </div>
    <div class="examples"><b>JSON Trace</b><span class='highlight active' data-highlight-id='user-message'>{
    "role": "user", 
    "content": "Hello, how are you?"
}</span>,
<div class='edge-spacer'></div><span class='highlight' data-highlight-id='assistant-message'>{
 "role": "assistant", 
 "content": "I'm doing well, thank you!", 
 "tool_calls": [
    <span class='highlight' data-highlight-id='tool-call'>{
        "id": "1", 
        "type": "function", 
        "function": {
            "name": "get_inbox", 
            "arguments": {}
        }
    }</span>
 ]
},</span>
<div class='edge-spacer'></div>
<span class='highlight' data-highlight-id='tool-output'>{
    "role": "tool", 
    "tool_call_id": "1", 
    "content": "1. Subject: Hello, From: Alice, Date: 2024-01-01, 2. Subject: Meeting, From: Bob, Date: 2024-01-02"
}</span>
    </div>
    <figcaption>
        The format of an agentic trace (hover over the nodes to see the relationships).
    </figcaption>
</div>

## Agent Trace

An agent trace is a sequence of events generated by an agent during a multi-turn interaction or reasoning process. It consists of a sequence of `Event` objects, each being concretized as one of the classes defined below (`Message`, `ToolCall`, `ToolOutput`, etc.).

In a guardrailing rule, you can then use these types, to quantify and check your agentic traces for behaviors:

```python
raise "Found pattern" if:
    (msg: Message) # <- checks every agent message (user, system, assistant)
    
    (call: ToolCall) # <- checks every tool call
    
    (output: ToolOutput) # <- checks every tool output

    # actual rule logic
```

The rule logic above, will be applied to every `Message`, `ToolCall`, and `ToolOutput` object encountered during operation, enabling you to easily check your agents for bad behaviors. 

## Data Model

The underlying data model is defined as follows and derived from the [OpenAI chat data structure](https://platform.openai.com/docs/api-reference/chat/create).

### Message

```python
class Message(Event):
    role: str
    content: Optional[str] | list[Content]
    tool_calls: Optional[list[ToolCall]]

# base class for multi-modal content chunks
class Content:
    type: str

# text content
class TextContent(Content):
    type: str = "text"
    text: str

# image content
class ImageContent(Content):
    type: str = "image"
    image_url: str
```

##### `role` <span class='type'>string</span> <span class='required'/>

The role of the event, e.g., `user`, `assistant`, `system` or something else.

##### `content` <span class='type'>string | list[Content]</span> <span class='optional'/>

The content of the event, e.g., agent reasoning and intermediate results. 

Content can be a string or a list of `Content` objects, i.e. text and image chunks.

##### `tool_calls` <span class='type'>list[ToolCall]</span> <span class='optional'/>

A list of tool calls made by the agent as part of this message.

!!! note "Examples"
    Simple message
    
    ```
    { "role": "user", "content": "Hello, how are you?" }
    ```
    
    Message with tool call
    
    ```json
    { 
        "role": "assistant", 
        "content": "Checking your inbox...", 
        "tool_calls": [
            { 
                "id": "1", 
                "type": "function", 
                "function": { 
                    "name": "get_inbox", 
                    "arguments": {
                        "n": 10
                    }
                }
            }
        ]
    }
    ```

### ToolCall

```python
class ToolCall:
    id: str
    type: str
    function: Function

class Function:
    name: str
    arguments: dict
```

<!-- * `id (str)`: A unique identifier for the tool call.
* `type (str)`: The type of the tool call, e.g., `function`.
* `function (Function)`: The function call made by the agent.
    * `name (str)`: The name of the function called.
    * `arguments (Dict[str, Any])`: The arguments passed to the function, encoded as a JSON dictionary. -->

##### `id` <span class='type'>string</span> <span class='required'/>

A unique identifier for the tool call.

##### `type` <span class='type'>string</span> <span class='required'/>

The type of the tool call, e.g., `function`.

##### `function` <span class='type'>Function</span> <span class='required'/>

The function call made by the agent.

* ##### `name` <span class='type'>string</span> <span class='required'/>

    The name of the function called.

* ##### `arguments` <span class='type'>dict</span> <span class='required'/>

    The arguments passed to the function, encoded as a JSON dictionary.

!!! note "Example"
    A tool call to get the latest 10 emails from the user's inbox.
    
    ```json
    {
        "id": "1",
        "type": "function",
        "function": {
            "name": "get_inbox",
            "arguments": {
                "n": 10
            }
        }
    }
    ```

### `ToolOutput`

A special event type for tool outputs, associated with a previous `ToolCall`.

```python
class ToolOutput(Message):
    role: str
    content: str | list[Content]
    tool_call_id: Optional[str]
```

##### `role` <span class='type'>string</span> <span class='required'/>

The role of the event, e.g., `tool`.

##### `content` <span class='type'>string</span> <span class='required'/>

The content of the tool output, e.g., the result of a function call.

Content can be a string or a list of `Content` objects, i.e. text and image chunks (see [Message](#message) for more details).

##### `tool_call_id` <span class='type'>string</span> <span class='optional'/>

The identifier of a previous ToolCall that this output corresponds to.

!!! note "Example"
    A tool output from the assistant to the tool.
    
    ```json
    {
        "role": "tool",
        "tool_call_id": "1",
        "content": "1. Subject: Hello, From: Alice, Date: 2024-01-01, 2. Subject: Meeting, From: Bob, Date: 2024-01-02"
    }
    ```

### Full Trace Example

The format suitable for Invariant is a list of `Event` objects. Here is an example of a trace with a user asking for their inbox, the assistant fetching the inbox, and the assistant listing the inbox contents.

```json
[
    {
        "role": "user", 
        "content": "What's in my inbox?"
    }, 
    {
        "role": "assistant",
        "content": "Here are the latest emails.", 
        "tool_calls": [
            {
                "id": "1",
                "type": "function",
                "function": {
                    "name": "get_inbox",
                    "arguments": {}
                }
            }
        ]
    },
    {
        "role": "tool",
        "tool_call_id": "1",
        "content": "1. Subject: Hello, From: Alice, Date: 2024-01-0, 2. Subject: Meeting, From: Bob, Date: 2024-01-02"
    },
    {
        "role": "assistant",
        "content": "You have 2 new emails."
    }
]
```